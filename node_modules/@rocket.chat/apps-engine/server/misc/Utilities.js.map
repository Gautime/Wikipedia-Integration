{"version":3,"sources":["src/server/misc/Utilities.ts"],"names":[],"mappings":"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","file":"Utilities.js","sourcesContent":["import cloneDeep = require('lodash.clonedeep');\nimport * as path from 'path';\nimport * as vm from 'vm';\n\nimport { ICompilerFile } from '../compiler';\n\nenum AllowedInternalModules {\n    path,\n    url,\n    crypto,\n    buffer,\n}\n\nexport class Utilities {\n    public static deepClone<T>(item: T): T {\n        return cloneDeep(item);\n    }\n\n    public static deepFreeze<T>(item: any): T {\n        Object.freeze(item);\n\n        Object.getOwnPropertyNames(item).forEach((prop: string) => {\n            // tslint:disable-next-line:max-line-length\n            if (item.hasOwnProperty(prop) && item[prop] !== null && (typeof item[prop] === 'object' || typeof item[prop] === 'function') && !Object.isFrozen(item[prop])) {\n                Utilities.deepFreeze(item[prop]);\n            }\n        });\n\n        return item;\n    }\n\n    public static deepCloneAndFreeze<T>(item: T): T {\n        return Utilities.deepFreeze(Utilities.deepClone(item));\n    }\n\n    public static transformModuleForCustomRequire(moduleName: string): string {\n        return path.normalize(moduleName).replace(/\\.\\.?\\//g, '').replace(/^\\//, '') + '.ts';\n    }\n\n    public static allowedInternalModuleRequire(moduleName: string): boolean {\n        return moduleName in AllowedInternalModules;\n    }\n\n    public static buildCustomRequire(files: { [s: string]: ICompilerFile }, currentPath: string = '.'): (mod: string) => {} {\n        return function _requirer(mod: string): any {\n            // Keep compatibility with apps importing apps-ts-definition\n            if (mod.startsWith('@rocket.chat/apps-ts-definition/')) {\n                mod = path.normalize(mod);\n                mod = mod.replace('@rocket.chat/apps-ts-definition/', '../../definition/');\n                return require(mod);\n            }\n\n            if (mod.startsWith('@rocket.chat/apps-engine/definition/')) {\n                mod = path.normalize(mod);\n                mod = mod.replace('@rocket.chat/apps-engine/definition/', '../../definition/');\n                return require(mod);\n            }\n\n            if (Utilities.allowedInternalModuleRequire(mod)) {\n                return require(mod);\n            }\n\n            if (currentPath !== '.') {\n                mod = path.join(currentPath, mod);\n            }\n\n            const transformedModule = Utilities.transformModuleForCustomRequire(mod);\n\n            if (files[transformedModule]) {\n                const ourExport = {};\n                const context = vm.createContext({\n                    require: Utilities.buildCustomRequire(files, path.dirname(transformedModule) + '/'),\n                    console,\n                    exports: ourExport,\n                    process: {},\n                });\n\n                vm.runInContext(files[transformedModule].compiled, context);\n\n                return ourExport;\n            }\n        };\n    }\n}\n"]}